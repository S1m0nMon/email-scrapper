<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Gmail ìŠ¤ìºë„ˆ Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .msg-content {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            background: white;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-5">
        <h1 class="mb-4">ğŸ“§ ë©”ì¼ ìƒì„¸ ìŠ¤ìºë„ˆ</h1>

        <div class="card mb-4">
            <div class="card-body">
                <form action="/login" method="get" class="row g-3">
                    <div class="col-md-5">
                        <input type="text" name="keyword" class="form-control" placeholder="ê²€ìƒ‰ í‚¤ì›Œë“œ (ì˜ˆ: ìŠ¹ì¸, ê²°ì œ)">
                    </div>
                    <div class="col-md-3">
                        <select name="days" class="form-select">
                            <option value="7">ìµœê·¼ 1ì£¼</option>
                            <option value="30">ìµœê·¼ 1ë‹¬</option>
                            <option value="90" selected>ìµœê·¼ 3ë‹¬</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary w-100">ê³„ì • ì—°ë™ ë° ê²€ìƒ‰</button>
                    </div>
                </form>
            </div>
        </div>

        {% if data %}
        <div class="list-group shadow-sm">
            {% for item in data %}
            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                <div onclick="viewMessage('{{ item.id }}')" style="cursor:pointer; flex-grow: 1;">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">{{ item.subject }}</h5>
                        <small>{{ item.date }}</small>
                    </div>
                    <p class="mb-1 text-muted">{{ item.snippet }}</p>
                    <small class="badge bg-info text-dark">{{ item.extracted_price }}</small>
                    {% if item.has_attachments %}
                    <span class="badge bg-warning text-dark">ğŸ“ ì²¨ë¶€íŒŒì¼ ìˆìŒ</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div class="modal fade" id="msgModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ë©”ì¼ ìƒì„¸ ë³´ê¸°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="attachmentsArea" class="mb-3"></div>
                    <div id="mailBody" class="msg-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const modal = new Bootstrap.Modal(document.getElementById('msgModal'));

        async function viewMessage(msgId) {
            const bodyDiv = document.getElementById('mailBody');
            const attachDiv = document.getElementById('attachmentsArea');
            bodyDiv.innerHTML = "ë¡œë”© ì¤‘...";
            attachDiv.innerHTML = "";
            modal.show();

            try {
                const response = await fetch(`/message/${msgId}`);
                const data = await response.json();

                if (data.error) throw new Error(data.error);

                // ë³¸ë¬¸ í‘œì‹œ (HTMLì´ ìˆìœ¼ë©´ HTML, ì—†ìœ¼ë©´ Text)
                bodyDiv.innerHTML = data.html || `<pre>${data.text}</pre>`;

                // ì²¨ë¶€íŒŒì¼ ë²„íŠ¼ ìƒì„±
                if (data.attachments && data.attachments.length > 0) {
                    let html = "<h6>ì²¨ë¶€íŒŒì¼:</h6>";
                    data.attachments.forEach(file => {
                        html += `<a href="/attachment/${msgId}/${file.id}/${file.filename}" class="btn btn-sm btn-outline-secondary me-2 mb-2">ğŸ’¾ ${file.filename} (${Math.round(file.size / 1024)}KB)</a>`;
                    });
                    attachDiv.innerHTML = html;
                }
            } catch (err) {
                bodyDiv.innerHTML = `<p class="text-danger">ì˜¤ë¥˜: ${err.message}</p>`;
            }
        }
    </script>
</body>

</html>